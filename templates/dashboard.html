{% extends "base.html" %}
{% block title %}Dasbor Analisis{% endblock %}

{% block scripts %}
<!-- Impor WordCloud2.js -->
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
<!-- Impor Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // --- Data dari Python ---
  const keywords = {{ keywords_json | safe }};
  const ner_data = {{ ner_json | safe }};
  const media_data = {{ media_json | safe }};

  // --- Ambil Referensi Elemen ---
  const dropdownButton = document.getElementById('analysisDropdownButton');
  
  // Wrapper (pembungkus) untuk setiap bagian analisis
  const wordCloudWrapper = document.getElementById('wordCloudWrapper');
  const nerChartWrapper = document.getElementById('nerChartWrapper');
  const mediaChartWrapper = document.getElementById('mediaChartWrapper');
  const searchResultsWrapper = document.getElementById('searchResultsWrapper');
  
  // Tombol di dalam dropdown
  const btnWordCloud = document.getElementById('showWordCloud');
  const btnNer = document.getElementById('showNer');
  const btnMedia = document.getElementById('showMedia');

  const allWrappers = [wordCloudWrapper, nerChartWrapper, mediaChartWrapper, searchResultsWrapper];

  // --- Fungsi untuk Menampilkan/Menyembunyikan Analisis ---
  function showAnalysis(analysisType, buttonText) {
    // 1. Sembunyikan semua wrapper
    allWrappers.forEach(wrapper => {
        wrapper.style.display = 'none';
    });

    // 2. Tampilkan wrapper yang dipilih
    if (analysisType === 'wordCloud') {
      wordCloudWrapper.style.display = 'block';
      searchResultsWrapper.style.display = 'block'; // Tampilkan juga hasil pencarian
    } else if (analysisType === 'ner') {
      nerChartWrapper.style.display = 'block';
    } else if (analysisType === 'media') {
      mediaChartWrapper.style.display = 'block';
    }
    
    // 3. Ubah teks tombol dropdown
    dropdownButton.textContent = buttonText;
  }

  // --- Tambahkan Event Listener ke Tombol Dropdown ---
  btnWordCloud.addEventListener('click', (e) => {
    e.preventDefault();
    showAnalysis('wordCloud', 'Analisis: Topik & Kata Kunci');
  });
  btnNer.addEventListener('click', (e) => {
    e.preventDefault();
    showAnalysis('ner', 'Analisis: Lokasi & Organisasi');
  });
  btnMedia.addEventListener('click', (e) => {
    e.preventDefault();
    showAnalysis('media', 'Analisis: Media Paling Aktif');
  });


  // --- 1. Inisialisasi Word Cloud ---
  if (keywords.length > 0) {
    const wordList = keywords.map(item => [item.word, item.weight]);
    const canvas = document.getElementById('wordCloudCanvas');
    WordCloud(canvas, {
      list: wordList,
      weightFactor: 3.5,
      minSize: 12,
      fontFamily: '"Poppins", sans-serif',
      color: function (word, weight) {
        const colors = ['#0052a3', '#0066cc', '#3498db', '#555', '#333', '#2c3e50'];
        return colors[Math.floor(Math.random() * colors.length)];
      },
      backgroundColor: '#ffffff',
      gridSize: 10,
      minRotation: 0,
      maxRotation: 0,
      click: function(item) {
        const word = item[0];
        searchByWord(word); // Panggil fungsi pencarian
      }
    });
  }

  // --- 2. Inisialisasi Bar Chart NER ---
  if (ner_data.length > 0) {
    const ctx = document.getElementById('nerChartCanvas').getContext('2d');
    const labels = ner_data.map(item => item.text);
    const counts = ner_data.map(item => item.count);
    const colors = ner_data.map(item => {
        return (item.label === 'ORG') ? 'rgba(231, 76, 60, 0.7)' : 'rgba(0, 102, 204, 0.7)';
    });

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Entitas (Lokasi/Organisasi) Teratas',
          data: counts,
          backgroundColor: colors,
        }]
      },
      options: {
        indexAxis: 'y', 
        responsive: true,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Entitas yang Paling Sering Disebutkan' }
        }
      }
    });
  }

  // --- 3. Inisialisasi Doughnut Chart Media ---
  if (media_data.length > 0) {
    const ctxMedia = document.getElementById('mediaChartCanvas').getContext('2d');
    const labels = media_data.map(item => item.media_name);
    const counts = media_data.map(item => item.count);
    const backgroundColors = ['#0066cc', '#2c3e50', '#3498db', '#95a5a6', '#7f8c8d'];

    new Chart(ctxMedia, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          label: 'Jumlah Permintaan',
          data: counts,
          backgroundColor: backgroundColors,
          hoverOffset: 4
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: { display: true, text: 'Top 5 Media Paling Aktif' }
        }
      }
    });
  }

  // --- 4. Fungsi Klik Word Cloud (Dengan Auto-Scroll) ---
  const searchResults = document.getElementById('searchResults');
  const resultsHeader = document.getElementById('resultsHeader');
  
  const searchByWord = async (word) => {
    resultsHeader.innerHTML = `Mencari hasil untuk "<strong>${word}</strong>"...`;
    searchResults.innerHTML = ''; 
    
    // --- PERBAIKAN AUTO-SCROLL ---
    document.getElementById('resultsHeader').scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });

    try {
      const response = await fetch(`/search_by_keyword?q=${word}`);
      const data = await response.json();
      if (data.results && data.results.length > 0) {
        let html = '';
        data.results.forEach(item => {
          const regex = new RegExp(`(${word})`, 'gi');
          const highlightedTranscript = item.transcript
            .substring(0, 250)
            .replace(regex, '<mark>$1</mark>');

          html += `
            <div class="result-card">
              <h6>Token: ${item.token}</h6>
              <blockquote class="result-quote">...${highlightedTranscript}...</blockquote>
            </div>
          `;
        });
        searchResults.innerHTML = html;
      } else {
        searchResults.innerHTML = '<p class="text-muted">Tidak ada transkrip yang cocok ditemukan.</p>';
      }
    } catch (error) {
      console.error('Gagal mencari:', error);
      searchResults.innerHTML = '<p class="text-danger">Gagal memuat hasil.</p>';
    }
  };
});
</script>
{% endblock %}

{% block content %}
<style>
  .dashboard-container {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 2rem;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
  }
  .dashboard-container h1 {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #1f2937;
  }
  #wordCloudCanvas {
    width: 100%;
    height: 400px;
    margin-bottom: 2rem;
    cursor: pointer;
  }
  .result-card {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  .result-quote {
    font-size: 0.9rem;
    background: #f9fafb;
    padding: 0.75rem;
    border-left: 4px solid #007bff;
    margin-top: 0.5rem;
  }
  .chart-container {
      border: 1px solid #e5e7eb;
      padding: 1rem;
      border-radius: 8px;
  }
  #mediaChartCanvas {
      max-height: 300px;
  }
  
  /* --- STYLE BARU UNTUK DROPDOWN --- */
  .analysis-content {
      display: none; /* Sembunyikan semua chart by default */
  }

  .analysis-dropdown-btn {
      background-color: #f8f9fa; /* Warna agar tidak putih polos */
      border: 1px solid #e0e0e0;
      width: 100%; /* Lebar penuh */
      text-align: left;
      font-weight: 500;
  }

  .analysis-dropdown-btn:hover {
      background-color: #e9ecef; /* Warna hover */
  }
  
  .analysis-dropdown-btn::after {
      /* Pindahkan panah dropdown ke kanan */
      margin-left: auto;
      float: right;
      margin-top: 10px;
  }
  
  .dropdown-menu {
      width: 100%; /* Buat menu selebar tombolnya */
  }

</style>

<div class="dashboard-container">
  <h1>Dasbor Analisis NLP</h1>
  <p class="text-muted mb-4">Analisis otomatis dari semua transkrip wawancara.</p>
  
  <!-- === PERUBAHAN 1: DROPDOWN SELEKTOR === -->
  <div class="dropdown mb-4">
    <button class="btn btn-light dropdown-toggle analysis-dropdown-btn" type="button" id="analysisDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
      Pilih Analisis
    </button>
    <ul class="dropdown-menu" aria-labelledby="analysisDropdownButton">
      <li><a class="dropdown-item" href="#" id="showWordCloud">Topik & Kata Kunci (TF-IDF)</a></li>
      <li><a class="dropdown-item" href="#" id="showNer">Lokasi & Organisasi (NER)</a></li>
      <li><a class="dropdown-item" href="#" id="showMedia">Media Paling Aktif</a></li>
    </ul>
  </div>

  <!-- === PERUBAHAN 2: WRAPPER UNTUK SETIAP CHART === -->

  <!-- Kolom Kiri: Word Cloud -->
  <div id="wordCloudWrapper" class="analysis-content">
    <h3 class="h5">Topik & Kata Kunci Teratas (TF-IDF)</h3>
    <div class="chart-container">
        <canvas id="wordCloudCanvas"></canvas>
    </div>
  </div>
  
  <!-- Kolom Kanan: NER Chart & Media Chart -->
  <div id="nerChartWrapper" class="analysis-content">
    <h3 class="h5">Lokasi & Organisasi Teratas (NER)</h3>
    <div class="chart-container mb-4">
        <canvas id="nerChartCanvas
