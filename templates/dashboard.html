{% extends "base.html" %}
{% block title %}Dasbor Analisis{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const keywords = {{ keywords_json | safe }};
  
  if (keywords.length === 0) {
    return;
  }

  const wordList = keywords.map(item => [item.word, item.weight]);
  
  const canvas = document.getElementById('wordCloudCanvas');
  const searchResults = document.getElementById('searchResults');
  const resultsHeader = document.getElementById('resultsHeader');

  // --- FUNGSI UNTUK FITUR KLIK (DENGAN SCROLL) ---
  const searchByWord = async (word) => {
    resultsHeader.innerHTML = `Mencari hasil untuk "<strong>${word}</strong>"...`;
    searchResults.innerHTML = ''; // Kosongkan hasil lama

    // --- PERBAIKAN 2: AUTO-SCROLL ---
    // Pindahkan 'scrollIntoView' ke sini agar langsung scroll
    document.getElementById('resultsHeader').scrollIntoView({
      behavior: 'smooth', // Animasi scroll
      block: 'start'      // Scroll ke bagian atas elemen
    });

    try {
      const response = await fetch(`/search_by_keyword?q=${word}`);
      const data = await response.json();

      if (data.results && data.results.length > 0) {
        let html = '';
        data.results.forEach(item => {
          const regex = new RegExp(`(${word})`, 'gi');
          const highlightedTranscript = item.transcript
            .substring(0, 250)
            .replace(regex, '<mark>$1</mark>');

          html += `
            <div class="result-card">
              <h6>Token: ${item.token}</h6>
              <p class="text-muted mb-1">
                Pewawancara: ${item.interviewer_name} | Narasumber: ${item.interviewee}
              </p>
              <blockquote class="result-quote">
                ...${highlightedTranscript}...
              </blockquote>
            </div>
          `;
        });
        searchResults.innerHTML = html;
      } else {
        searchResults.innerHTML = '<p class="text-muted">Tidak ada transkrip yang cocok ditemukan.</p>';
      }
    } catch (error) {
      console.error('Gagal mencari:', error);
      searchResults.innerHTML = '<p class="text-danger">Gagal memuat hasil.</p>';
    }
  };

  // --- PERBAIKAN 1: INISIALISASI WORD CLOUD MODERN ---
  WordCloud(canvas, {
    list: wordList,
    
    // --- Pengaturan Tampilan ---
    weightFactor: 3.5, // Buat kata-kata lebih besar
    minSize: 12,       // Ukuran font minimum
    fontFamily: '"Poppins", sans-serif',
    
    // Palet warna kustom (lebih modern)
    color: function (word, weight) {
      const colors = ['#0052a3', '#0066cc', '#3498db', '#555', '#333', '#2c3e50'];
      return colors[Math.floor(Math.random() * colors.length)];
    },
    
    backgroundColor: '#ffffff', // Latar belakang putih
    gridSize: 10,
    
    // Hapus rotasi acak agar terlihat rapi
    minRotation: 0,
    maxRotation: 0,
    
    // --- Pengaturan Fungsionalitas ---
    click: function(item) {
      const word = item[0];
      searchByWord(word); // Panggil fungsi pencarian & scroll
    }
  });
});
</script>
{% endblock %}

{% block content %}
<style>
  .dashboard-container {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 2rem;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
  }
  .dashboard-container h1 {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #1f2937;
  }
  
  /* Hapus border kaku dan biarkan kata-kata "mengambang" */
  #wordCloudCanvas {
    width: 100%;
    height: 400px; /* Anda bisa sesuaikan ini */
    margin-bottom: 2rem;
    cursor: pointer; /* Tunjukkan bahwa ini bisa diklik */
  }
  
  .result-card {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  .result-quote {
    font-size: 0.9rem;
    background: #f9fafb;
    padding: 0.75rem;
    border-left: 4px solid #007bff;
    margin-top: 0.5rem;
  }
</style>

<div class="dashboard-container">
  <h1>Dasbor Analisis Topik</h1>
  <p class="text-muted mb-4">Kata kunci paling penting dari semua transkrip. Klik sebuah kata untuk melihat wawancara terkait.</p>

  <canvas id="wordCloudCanvas"></canvas>

  <div class="search-results-container">
    <h3 id="resultsHeader" class="mt-5 mb-3">Hasil Pencarian</h3>
    <div id="searchResults">
      <p class="text-muted">Klik sebuah kata di awan di atas untuk melihat hasilnya di sini.</p>
    </div>
  </div>
</div>
{% endblock %}
