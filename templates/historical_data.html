{% extends "base.html" %}

{% block title %}Data Historis Wawancara{% endblock %}

{% block content %}
<section class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="display-6 fw-bold mb-0">Data Historis Wawancara</h1>
    <a href="{{ url_for('request_interview') }}" class="btn btn-primary">
      <i class="bi bi-plus me-1"></i> Ajukan Baru
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <!-- Tambahkan 'vertical-align: middle' agar rapi -->
        <table class="table table-hover table-striped" style="vertical-align: middle;">
          <thead class="table-light">
            <tr>
              <!-- 
                PERUBAHAN 1:
                Menambah kolom 'Ringkasan' (ikon +) dan 'Laporan' (PDF)
                Menghapus 'ID' agar lebih ringkas
              -->
              <th scope="col" style="width: 40px;"></th> <!-- Kolom untuk ikon + -->
              <th scope="col">Tanggal</th>
              <th scope="col">Pewawancara</th>
              <th scope="col">Media</th>
              <th scope="col">Topik</th>
              <th scope="col">Metode</th>
              <th scope="col">Token</th>
              <th scope="col">Laporan</th>
            </tr>
          </thead>
          <tbody>
            {% for request in historical_data %}
              <!-- BARIS DATA UTAMA -->
              <tr>
                <!-- 
                  PERUBAHAN 2: Tombol Buka/Tutup Ringkasan
                  Hanya muncul jika 'request.summary' ada
                -->
                <td>
                  {% if request.summary %}
                    <a class="btn btn-sm btn-outline-secondary py-0 px-1" 
                       data-bs-toggle="collapse" 
                       href="#summary-{{ request.id }}" 
                       role="button">
                      <i class="bi bi-plus-lg"></i>
                    </a>
                  {% endif %}
                </td>
                
                <!-- Mengubah format tanggal agar lebih rapi -->
                <td>{{ request.request_date.strftime('%d %b %Y') if request.request_date else '-' }}</td>
                <td>{{ request.interviewer_name|e }}</td>
                <td>{{ request.media_name|e }}</td>
                <td>
                  <span title="{{ request.topic|e }}">
                    {{ request.topic[:30]|e }}{% if request.topic|length > 30 %}...{% endif %}
                  </span>
                </td>
                <td>
                  {% if request.method == 'telepon' %}
                  <span class="badge bg-primary rounded-pill">Telepon</span>
                  {% elif request.method == 'whatsapp' %}
                  <span class="badge bg-success rounded-pill">WhatsApp</span>
                  {% elif request.method == 'langsung' %}
                  <span class="badge bg-warning text-dark rounded-pill">Tatap Muka</span>
                  {% else %}
                  <span class="badge bg-info rounded-pill">Virtual</span>
                  {% endif %}
                </td>
                <td>
                  <code class="user-select-all">{{ request.token|e }}</code>
                </td>

                <!-- 
                  PERUBAHAN 3: Tombol Unduh PDF
                  Menggunakan 'request.recording_id' yang kita ambil di app.py
                -->
                <td>
                  {% if request.recording_id %}
                    <a href="{{ url_for('generate_pdf', recording_id=request.recording_id) }}" class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-file-earmark-pdf"></i> PDF
                    </a>
                  {% else %}
                    <span class="text-muted small">N/A</span>
                  {% endif %}
                </td>
              </tr>
              
              <!-- 
                PERUBAHAN 4: Baris Ringkasan (Tersembunyi)
                Baris ini akan muncul saat tombol '+' diklik
              -->
              {% if request.summary %}
              <tr class="collapse" id="summary-{{ request.id }}">
                <td colspan="8"> <!-- 'colspan="8"' mencakup semua 8 kolom -->
                  <div class="alert alert-light p-3" style="background-color: #fcfcfc; border: 1px dashed #e0e0e0;">
                    <strong>Ringkasan Otomatis:</strong>
                    <p class="mb-0 fst-italic">"{{ request.summary }}"</p>
                  </div>
                </td>
              </tr>
              {% endif %}
              
            {% else %}
              <tr>
                <td colspan="8" class="text-center text-muted py-4">
                  Tidak ada data wawancara yang tersedia
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<!-- 
  PERUBAHAN 5: JavaScript untuk mengubah ikon '+' menjadi '-'
-->
<script>
document.addEventListener("DOMContentLoaded", function() {
    var collapseElements = [].slice.call(document.querySelectorAll('[data-bs-toggle="collapse"]'));
    
    // Gunakan event 'shown.bs.collapse' dan 'hidden.bs.collapse'
    collapseElements.map(function(el) {
        // Saat dibuka
        el.addEventListener('shown.bs.collapse', function(event) {
            // Cari tombol 'a' yang mengontrolnya
            var trigger = document.querySelector(`[href="#${event.target.id}"]`);
            if (trigger) {
                var icon = trigger.querySelector('i');
                icon.classList.remove('bi-plus-lg');
                icon.classList.add('bi-dash-lg');
            }
        });

        // Saat ditutup
        el.addEventListener('hidden.bs.collapse', function(event) {
            var trigger = document.querySelector(`[href="#${event.target.id}"]`);
            if (trigger) {
                var icon = trigger.querySelector('i');
                icon.classList.remove('bi-dash-lg');
                icon.classList.add('bi-plus-lg');
            }
        });
    });
});
</script>
{% endblock %}
