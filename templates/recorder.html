{% extends "base.html" %}
{% block title %}Recorder Wawancara{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Referensi Elemen
    const recordButton = document.getElementById("recordButton");
    const stopButton = document.getElementById("stopButton");
    const audioPlayer = document.getElementById("audioPlayer");
    const saveButton = document.getElementById("saveButton"); // Tombol utama
    const tokenSelect = document.getElementById("tokenSelect");
    const intervieweeSelect = document.getElementById("intervieweeSelect");
    const tokenInfo = document.getElementById("tokenInfo");
    const transcriptText = document.getElementById("transcriptText"); // Textarea untuk STT

    // Variabel untuk data auto-fill
    let autoFilledInterviewer = "";
    let autoFilledMedia = "";
    let autoFilledTopic = "";
    let autoFilledTime = "";
    let autoFilledMethod = "";

    // Variabel Perekaman
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let audioBlob;
    
    // Variabel Speech-to-Text (STT)
    let recognition;
    let finalTranscript = ''; // Menyimpan teks final

    // --- Inisialisasi Speech Recognition (STT) ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = true; // Terus merekam
      recognition.interimResults = true; // Tampilkan hasil sementara
      recognition.lang = "id-ID";

      // Saat STT mendapatkan hasil
      recognition.onresult = (event) => {
        let interimTranscript = '';
        // Ulangi hasil untuk membangun string
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + ' '; // Tambahkan ke transkrip final
          } else {
            interimTranscript += transcript; // Kumpulkan transkrip sementara
          }
        }
        // Perbarui textarea dengan gabungan final + sementara
        transcriptText.value = finalTranscript + interimTranscript;
      };

      // Tangani error STT
      recognition.onerror = (event) => {
        console.error("Speech recognition error", event.error);
        if(event.error == 'no-speech' || event.error == 'audio-capture') {
           // Jangan tampilkan alert jika hanya hening atau error mikrofon
        } else {
            alert(`Terjadi error STT: ${event.error}`);
        }
      };

      // Saat STT berhenti
      recognition.onend = () => {
        if (isRecording) {
          // Jika berhenti tapi kita masih merekam, mulai lagi
          try { 
            recognition.start(); 
          } catch(e) { 
            console.warn("STT restart blocked by browser."); 
          }
        }
      };
    } else {
      alert("Browser Anda tidak mendukung Speech Recognition (STT) live.");
    }
    // --- Akhir Inisialisasi STT ---


    // --- Fungsi Otomatisasi Form (Sudah Benar) ---
    async function fetchTokenData(token) {
      if (!token) {
        tokenInfo.textContent = "";
        autoFilledInterviewer = "";
        autoFilledMedia = "";
        autoFilledTopic = "";
        autoFilledTime = "";
        return;
      }
      try {
        const response = await fetch(`/get_topik/${token}`);
        if (!response.ok) throw new Error('Data token tidak ditemukan');
        
        const data = await response.json();
        if (data.interviewer_name) {
          // Simpan data ke variabel JavaScript
          autoFilledInterviewer = data.interviewer_name;
          autoFilledMedia = data.media_name;
          autoFilledTopic = data.topic;
          autoFilledTime = data.datetime;
          autoFilledMethod = data.method;
          
          // Tampilkan info ke pengguna
          tokenInfo.innerHTML = `
            <strong>Pewawancara:</strong> ${data.interviewer_name} (${data.media_name})<br>
            <strong>Topik:</strong> ${data.topic}
          `;
        } else {
          tokenInfo.textContent = "Error: Data tidak lengkap.";
        }
      } catch (error) {
        console.error("Gagal mengambil data token:", error);
        tokenInfo.textContent = "Gagal mengambil data dari server.";
      }
    }
    
    // Panggil fungsi di atas saat token diganti
    tokenSelect.addEventListener("change", function () {
      fetchTokenData(this.value);
    });

    // --- Kontrol Perekaman (DIMODIFIKASI) ---
    recordButton.addEventListener("click", async function () {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
        
        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: "audio/webm" }); 
          audioPlayer.src = URL.createObjectURL(audioBlob);
        };

        // Mulai media recorder
        mediaRecorder.start();
        
        // Mulai juga STT
        if (recognition) {
            finalTranscript = ''; // Reset transkrip
            transcriptText.value = ''; // Kosongkan textarea
            recognition.start(); // Mulai STT
        }

        // Atur tombol
        recordButton.disabled = true;
        stopButton.disabled = false;
        isRecording = true;
      } catch (error) {
        console.error("Error accessing microphone:", error);
        alert("Gagal mengakses mikrofon. Pastikan Anda memberikan izin.");
      }
    });

    stopButton.addEventListener("click", function () {
      if (mediaRecorder && isRecording) {
        // Hentikan media recorder
        mediaRecorder.stop();
        
        // Hentikan juga STT
        if (recognition) {
          recognition.stop();
        }
        
        // Atur tombol
        recordButton.disabled = false;
        stopButton.disabled = true;
        isRecording = false;
      }
    });

    // --- FUNGSI SIMPAN & UNDUH PDF (Alur Kerja Baru) ---
    saveButton.addEventListener("click", async function () {
      const selectedToken = tokenSelect.value;
      const selectedInterviewee = intervieweeSelect.value;
      const transcriptValue = transcriptText.value; // Ambil teks dari STT

      // Validasi
      if (!selectedToken || !selectedInterviewee) {
        alert("Harap isi semua field (Token dan Nama Narasumber)");
        return;
      }
      if (transcriptValue.trim().length === 0) {
        alert("Transkrip masih kosong. Silakan rekam suara Anda atau ketik manual.");
        return;
      }
      if (!autoFilledInterviewer) {
        alert("Data token (Pewawancara) belum terisi. Pilih token yang valid.");
        return;
      }

      // Buat FormData untuk dikirim
      const formData = new FormData();
      
      // 1. Kirim file audio (jika ada)
      if (audioBlob) {
         formData.append("audio_file", audioBlob, "recording.webm"); 
      }
      
      // 2. Kirim data formulir
      formData.append("token", selectedToken);
      formData.append("interviewee", selectedInterviewee);
      formData.append("transcript", transcriptValue); // <- Teks dari textarea
      
      // 3. Kirim data auto-fill untuk PDF
      formData.append("interviewer", autoFilledInterviewer);
      formData.append("media_name", autoFilledMedia);
      formData.append("topic", autoFilledTopic);
      formData.append("datetime", autoFilledTime);
      formData.append("method", autoFilledMethod);

      try {
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Memproses PDF...';

        // Panggil route backend baru
        // (Pastikan Anda sudah punya route /generate_report_now di Python)
        const response = await fetch("/generate_report_now", {
          method: "POST",
          body: formData,
        });

        if (response.ok) {
          // Sukses! Server mengembalikan file PDF
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Laporan_${selectedToken}.pdf`; // Nama file unduhan
          document.body.appendChild(a);
          a.click(); // Memicu unduhan
          a.remove();
          window.URL.revokeObjectURL(url);
          
          alert("Laporan PDF berhasil diunduh! Halaman akan dimuat ulang.");
          window.location.reload(); // Muat ulang halaman
        } else {
          // Tangani error dari server
          const errorData = await response.json();
          throw new Error(errorData.message || "Gagal membuat PDF");
        }
      } catch (error) {
        console.error("Error saving/generating PDF:", error);
        alert("Gagal: " + error.message);
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="bi bi-file-earmark-pdf me-1"></i> Simpan & Unduh PDF';
      }
    });
  });
</script>
{% endblock %} 

{% block content %}
<style>
  /* ... (CSS Anda sudah benar, tidak perlu diubah) ... */
</style>

<div class="recorder-container">
  <h1>Recorder Wawancara</h1>

  <div class="mb-3">
    <label for="tokenSelect" class="form-label">Token Wawancara</label>
    <select id="tokenSelect" class="form-control">
      <option value="">-- Pilih Token --</option>
      {% for token in tokens %}
        <option value="{{ token.token }}">{{ token.token }}</option>
      {% endfor %}
    </select>
    <small id="tokenInfo" class="text-muted d-block mt-1"></small>
  </div>

  <div class="mb-3">
    <label for="intervieweeSelect" class="form-label">Nama Narasumber (On Duty)</label>
    <select id="intervieweeSelect" class="form-control">
        <option value="">-- Pilih Nama --</option>
        <option value="Oky Sukma Hakim">Oky Sukma Hakim</option>
        <option value="Andre Wijaya">Andre Wijaya</option>
        <option value="Arief Krisna Widadi">Arief Krisna Widadi</option>
        <option value="Ary Pulung Baskoro">Ary Pulung Baskoro</option>
        <option value="Shanas Septi Prayuda">Shanas Septi Prayuda</option>
        <option value="Rendy Irawadi">Rendy Irawadi</option>
        <option value="Thariq Harun Al Rasyid">Thariq Harun Al Rasyid</option>
        <option value="Bhilda Maulida">Bhilda Maulida</option>
        <option value="Siska Anggraeni">Siska Anggraeni</option>
        <option value="Swati Ayudia">Swati Ayudia</option>
        <option value="Agatha Mayasari">Agatha Mayasari</option>
        <option value="Levi Ratnasari">Levi Ratnasari</option>
        <option value="Restina Wardhani">Restina Wardhani</option>
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label">Rekam Audio & STT</label>
    <div class="d-flex gap-2 mb-2">
      <button id="recordButton" type="button" class="btn btn-danger">
        <i class="bi bi-mic-fill me-1"></i> Mulai Rekam
      </button>
      <button id="stopButton" type="button" class="btn btn-secondary" disabled>
        <i class="bi bi-stop-fill me-1"></i> Stop
      </button>
    </div>
    <audio id="audioPlayer" controls class="w-100 mb-2"></audio>
    <small class="text-muted d-block mt-1">Rekaman audio dan transkrip akan dibuat secara bersamaan.</small>
  </div>
  
  <div class="mb-3">
      <label for="transcriptText" class="form-label">Transkrip Otomatis</label>
      <textarea class="form-control" id="transcriptText" rows="10" placeholder="Teks akan muncul di sini saat Anda berbicara..."></textarea>
      <small class="text-muted d-block mt-1">Anda dapat mengedit teks ini secara manual sebelum menyimpan.</small>
  </div>

  <div class="d-grid">
    <button id="saveButton" type="button" class="btn btn-primary">
      <i class="bi bi-file-earmark-pdf me-1"></i> Simpan & Unduh PDF
    </button>
  </div>
  
  </div>
{% endblock %}

