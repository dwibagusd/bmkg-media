{% extends "base.html" %}
{% block title %}Recorder Wawancara{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Referensi Elemen
    const recordButton = document.getElementById("recordButton");
    const stopButton = document.getElementById("stopButton");
    const audioPlayer = document.getElementById("audioPlayer");
    const saveButton = document.getElementById("saveButton");
    const tokenSelect = document.getElementById("tokenSelect");
    const intervieweeSelect = document.getElementById("intervieweeSelect");
    const tokenInfo = document.getElementById("tokenInfo");
    const transcriptText = document.getElementById("transcriptText");

    // Variabel untuk data auto-fill
    let autoFilledInterviewer = "";
    let autoFilledMedia = "";
    let autoFilledTopic = "";
    let autoFilledTime = "";
    let autoFilledMethod = ""; // (Kita tambahkan ini di langkah terakhir)

    // Variabel Perekaman
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let audioBlob;
    
    // Variabel Speech-to-Text (STT)
    let recognition;
    let finalTranscript = '';

    // --- Inisialisasi Speech Recognition (STT) ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = "id-ID";

      recognition.onresult = (event) => {
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + ' ';
          } else {
            interimTranscript += transcript;
          }
        }
        transcriptText.value = finalTranscript + interimTranscript;
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error", event.error);
      };

      recognition.onend = () => {
        if (isRecording) {
          try { recognition.start(); } catch(e) { console.warn("STT restart blocked."); }
        }
      };
    } else {
      alert("Browser Anda tidak mendukung Speech Recognition (STT) live.");
    }
    // --- Akhir Inisialisasi STT ---


    // --- Fungsi Otomatisasi Form ---
    async function fetchTokenData(token) {
      if (!token) {
        tokenInfo.textContent = "";
        autoFilledInterviewer = "";
        autoFilledMedia = "";
        autoFilledTopic = "";
        autoFilledTime = "";
        autoFilledMethod = "";
        return;
      }
      try {
        const response = await fetch(`/get_topik/${token}`);
        if (!response.ok) throw new Error('Data token tidak ditemukan');
        
        const data = await response.json();
        if (data.interviewer_name) {
          autoFilledInterviewer = data.interviewer_name;
          autoFilledMedia = data.media_name;
          autoFilledTopic = data.topic;
          autoFilledTime = data.datetime;
          autoFilledMethod = data.method; // (Mengambil data 'method')

          tokenInfo.innerHTML = `
            <strong class="d-block">Pewawancara:</strong> ${data.interviewer_name} (${data.media_name})
            <strong class="d-block">Topik:</strong> ${data.topic}
            <strong class="d-block">Saluran:</strong> ${data.method}
          `;
        } else {
          tokenInfo.textContent = "Error: Data tidak lengkap.";
        }
      } catch (error) {
        console.error("Gagal mengambil data token:", error);
        tokenInfo.textContent = "Gagal mengambil data dari server.";
      }
    }
    
    tokenSelect.addEventListener("change", function () {
      fetchTokenData(this.value);
    });

    // --- Kontrol Perekaman ---
    recordButton.addEventListener("click", async function () {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
        
        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: "audio/webm" }); 
          audioPlayer.src = URL.createObjectURL(audioBlob);
        };

        mediaRecorder.start();
        if (recognition) {
            finalTranscript = '';
            transcriptText.value = '';
            recognition.start();
        }

        recordButton.disabled = true;
        stopButton.disabled = false;
        isRecording = true;
      } catch (error) {
        console.error("Error accessing microphone:", error);
        alert("Gagal mengakses mikrofon. Pastikan Anda memberikan izin.");
      }
    });

    stopButton.addEventListener("click", function () {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        if (recognition) recognition.stop();
        
        recordButton.disabled = false;
        stopButton.disabled = true;
        isRecording = false;
      }
    });

    // --- FUNGSI SIMPAN & UNDUH PDF ---
    saveButton.addEventListener("click", async function () {
      const selectedToken = tokenSelect.value;
      const selectedInterviewee = intervieweeSelect.value;
      const transcriptValue = transcriptText.value;

      if (!selectedToken || !selectedInterviewee) {
        alert("Harap isi semua field (Token dan Nama Narasumber)");
        return;
      }
      if (transcriptValue.trim().length === 0) {
        alert("Transkrip masih kosong. Silakan rekam suara Anda.");
        return;
      }
      if (!autoFilledInterviewer) {
        alert("Data token (Pewawancara) belum terisi. Pilih token yang valid.");
        return;
      }

      const formData = new FormData();
      
      if (audioBlob) {
         formData.append("audio_file", audioBlob, "recording.webm"); 
      }
      
      formData.append("token", selectedToken);
      formData.append("interviewee", selectedInterviewee);
      formData.append("transcript", transcriptValue);
      formData.append("interviewer", autoFilledInterviewer);
      formData.append("media_name", autoFilledMedia);
      formData.append("topic", autoFilledTopic);
      formData.append("datetime", autoFilledTime);
      formData.append("method", autoFilledMethod); // (Mengirim data 'method')
      
      try {
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Memproses PDF...';

        const response = await fetch("/generate_report_now", {
          method: "POST",
          body: formData,
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Laporan_${selectedToken}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
          
          alert("Laporan PDF berhasil diunduh! Halaman akan dimuat ulang.");
          window.location.reload();

        } else {
          const errorData = await response.json();
          throw new Error(errorData.message || "Gagal membuat PDF");
        }
      } catch (error) {
        console.error("Error saving/generating PDF:", error);
        alert("Gagal: " + error.message);
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="bi bi-file-earmark-pdf me-1"></i> Simpan & Unduh PDF';
      }
    });
  });
</script>
{% endblock %} 

{% block content %}
<style>
  body {
    background-color: #f9fafb;
    font-family: 'Inter', 'Segoe UI', sans-serif;
    color: #333;
  }
  .recorder-container {
    max-width: 960px;
    margin: 2rem auto;
    padding: 2rem;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
  }
  .recorder-container h1 {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: #1f2937;
  }
  .form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
  }
  /* Ini akan memberi style pada dropdown dan textarea */
  .form-control {
    border-radius: 10px;
    border: 1px solid #d1d5db;
    padding: 0.75rem;
  }
  /* Ini memberi style pada <select> */
  .form-select {
     border-radius: 10px;
     border: 1px solid #d1d5db;
     padding: 0.75rem;
  }
  .btn-primary {
    background-color: #007bff;
    border: none;
    border-radius: 10px;
    padding: 0.75rem;
    font-weight: 500;
  }
  .btn-primary:hover {
    background-color: #0069d9;
  }
  .btn-danger, .btn-secondary {
    border-radius: 10px;
    padding: 0.6rem 1rem;
  }
  .text-muted {
    color: #6b7280 !important;
  }
  /* Mengatur tampilan info token agar lebih rapi */
  #tokenInfo {
    padding: 0.5rem 0.25rem;
    line-height: 1.6;
  }
  #tokenInfo strong {
      display: inline-block;
      min-width: 100px;
  }
</style>

<div class="recorder-container">
  <h1>Recorder Wawancara</h1>

  <div class="mb-3">
    <label for="tokenSelect" class="form-label">Token Wawancara</label>
    <select id="tokenSelect" class="form-select">
      <option value="">-- Pilih Token --</option>
      {% for token in tokens %}
        <option value="{{ token.token }}">{{ token.token }}</option>
      {% endfor %}
    </select>
    <small id="tokenInfo" class="text-muted d-block mt-1"></small>
  </div>

  <div class="mb-3">
    <label for="intervieweeSelect" class="form-label">Nama Narasumber (On Duty)</label>
    <select id="intervieweeSelect" class="form-select">
        <option value="">-- Pilih Nama --</option>
        <option value="Oky Sukma Hakim">Oky Sukma Hakim</option>
        <option value="Andre Wijaya">Andre Wijaya</option>
        <option value="Arief Krisna Widadi">Arief Krisna Widadi</option>
        <option value="Ary Pulung Baskoro">Ary Pulung Baskoro</option>
        <option value="Shanas Septi Prayuda">Shanas Septi Prayuda</option>
        <option value="Rendy Irawadi">Rendy Irawadi</option>
        <option value="Thariq Harun Al Rasyid">Thariq Harun Al Rasyid</option>
        <option value="Bhilda Maulida">Bhilda Maulida</option>
        <option value="Siska Anggraeni">Siska Anggraeni</option>
        <option value="Swati Ayudia">Swati Ayudia</option>
        <option value="Agatha Mayasari">Agatha Mayasari</option>
        <option value="Levi Ratnasari">Levi Ratnasari</option>
        <option value="Restina Wardhani">Restina Wardhani</option>
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label">Rekam Audio & STT</label>
    <div class="d-flex gap-2 mb-2">
      <button id="recordButton" type="button" class="btn btn-danger">
        <i class="bi bi-mic-fill me-1"></i> Mulai Rekam
      </button>
      <button id="stopButton" type="button" class="btn btn-secondary" disabled>
        <i class="bi bi-stop-fill me-1"></i> Stop
      </button>
    </div>
    <audio id="audioPlayer" controls class="w-100 mb-2"></audio>
    <small class="text-muted d-block mt-1">Rekaman audio dan transkrip akan dibuat secara bersamaan.</small>
  </div>
  
  <div class="mb-3">
      <label for="transcriptText" class="form-label">Transkrip Otomatis</label>
      <textarea class="form-control" id="transcriptText" rows="10" placeholder="Teks akan muncul di sini saat Anda berbicara..."></textarea>
      <small class="text-muted d-block mt-1">Anda dapat mengedit teks ini secara manual sebelum menyimpan.</small>
  </div>

  <div class="d-grid">
    <button id="saveButton" type="button" class="btn btn-primary">
      <i class="bi bi-file-earmark-pdf me-1"></i> Simpan & Unduh PDF
    </button>
  </div>
  
</div>
{% endblock %}
