{% extends "base.html" %}
{% block title %}Recorder Wawancara{% endblock %}
{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const recordButton = document.getElementById("recordButton");
    const stopButton = document.getElementById("stopButton");
    const audioPlayer = document.getElementById("audioPlayer");
    const saveButton = document.getElementById("saveButton");
    
    // Hapus referensi ke transcriptText
    // const transcriptText = document.getElementById("transcript"); 
    
    const tokenInput = document.getElementById("token");
    const intervieweeInput = document.getElementById("interviewee");
    const interviewerInput = document.getElementById("interviewer");

    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let audioBlob;

    // Check browser compatibility
    if (!navigator.mediaDevices) {
      alert("Browser Anda tidak mendukung fitur perekaman. Gunakan Chrome atau Edge terbaru.");
    }

    // --- SEMUA KODE SpeechRecognition DIHAPUS DARI SINI ---

    // Start recording
    recordButton.addEventListener("click", async function () {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = function (event) {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = function () {
          // DIUBAH: Gunakan format webm atau ogg, karena lebih umum
          // Pydub di backend bisa menangani ini
          audioBlob = new Blob(audioChunks, { type: "audio/webm" }); 
          audioPlayer.src = URL.createObjectURL(audioBlob);
          audioChunks = [];
        };

        mediaRecorder.start();
        // --- recognition.start() DIHAPUS ---

        recordButton.disabled = true;
        stopButton.disabled = false;
        isRecording = true;

        console.log("Recording started");
      } catch (error) {
        console.error("Error accessing microphone:", error);
        alert("Gagal mengakses mikrofon. Pastikan Anda memberikan izin.");
      }
    });

    // Stop recording
    stopButton.addEventListener("click", function () {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        // --- recognition.stop() DIHAPUS ---

        recordButton.disabled = false;
        stopButton.disabled = true;
        isRecording = false;

        console.log("Recording stopped");
      }
    });

    // Save recording
    saveButton.addEventListener("click", async function () {
      if (!audioBlob) {
        alert("Tidak ada rekaman yang disimpan. Silakan rekam terlebih dahulu.");
        return;
      }

      if (!tokenInput.value || !intervieweeInput.value || !interviewerInput.value) {
        alert("Harap isi semua field yang diperlukan (Token, Nama Pewawancara, Nama Narasumber)");
        return;
      }

      const formData = new FormData();
      // Kirim sebagai file .webm, ini lebih efisien
      formData.append("audio_file", audioBlob, "recording.webm"); 
      formData.append("token", tokenInput.value);
      formData.append("interviewee", intervieweeInput.value);
      formData.append("interviewer", interviewerInput.value);
      
      // --- formData.append("transcript", ...) DIHAPUS ---
      // Backend Anda (di route /recorder) sekarang akan 100% bertanggung jawab
      // untuk menjalankan transcribe_audio()

      try {
        // Tampilkan loading/disabled state
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Menyimpan & Memproses...';

        const response = await fetch("/recorder", {
          method: "POST",
          body: formData,
        });

        if (response.ok) {
          alert("Rekaman berhasil disimpan! Backend akan memproses transkrip.");
          window.location.reload();
        } else {
          throw new Error("Gagal menyimpan rekaman");
        }
      } catch (error) {
        console.error("Error saving recording:", error);
        alert("Gagal menyimpan rekaman: " + error.message);
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="bi bi-save me-1"></i> Simpan Rekaman';
      }
    });
  });
</script>
{% endblock %} 

{% block content %}
<style>
  /* ... (CSS Anda tidak perlu diubah, biarkan apa adanya) ... */
</style>

<div class="recorder-container">
  <h1>Recorder Wawancara</h1>

  <form>
    <div class="mb-3">
      <label for="token" class="form-label">Token Wawancara</label>
      <input type="text" class="form-control" id="token" placeholder="Masukkan token" />
    </div>

    <div class="mb-3">
      <label for="interviewer" class="form-label">Nama Pewawancara</label>
      <input type="text" class="form-control" id="interviewer" placeholder="Nama Pewawancara" />
    </div>

    <div class="mb-3">
      <label for="interviewee" class="form-label">Nama Narasumber</label>
      <input type="text" class="form-control" id="interviewee" placeholder="Nama Narasumber" />
    </div>

    <div class="mb-3">
      <label class="form-label">Rekam Audio</label>
      <div class="d-flex gap-2 mb-2">
        <button id="recordButton" type="button" class="btn btn-danger">
          <i class="bi bi-mic-fill me-1"></i> Mulai Rekam
        </button>
        <button id="stopButton" type="button" class="btn btn-secondary" disabled>
          <i class="bi bi-stop-fill me-1"></i> Stop
        </button>
      </div>
      <audio id="audioPlayer" controls class="w-100"></audio>
      <small class="text-muted d-block mt-1">Pastikan mikrofon Anda berfungsi dengan baik</small>
    </div>

    <div class="d-grid">
      <button id="saveButton" type="button" class="btn btn-primary">
        <i class="bi bi-save me-1"></i> Simpan Rekaman
      </button>
    </div>
  </form>

  <div class="recordings-list">
    <h4 class="mt-5 mb-3">Rekaman Tersimpan</h4>
    {% if not recordings %}
    <p class="text-muted">Belum ada rekaman wawancara.</p>
    {% else %}
    {% for recording in recordings %}
    <div class="recording-card">
      <h6>{{ recording.interviewee }}</h6>
      <p class="text-muted mb-1">Token: {{ recording.token }}</p>
      <p class="text-muted mb-2">Pewawancara: {{ recording.interviewer }} | Tanggal: {{ recording.date }}</p>
      
      <audio controls>
        <source src="{{ url_for('static', filename='uploads/' + recording.filename) }}" type="audio/wav" />
      </audio>
      
      <div class="mt-2">
        <a href="/generate-pdf/{{ recording.id }}" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-file-earmark-pdf"></i> Unduh PDF
        </a>
      </div>
    </div>
    {% endfor %}
    {% endif %}
  </div>
</div>
{% endblock %}
